# 智能共享单车系统 - 硬件接线指南

## 📦 硬件清单

### 主控板
- **ESP8266 NodeMCU** x1 （ESP-12E 模块）
- USB 数据线 x1

### 传感器模块
- **NEO-6M GPS 模块** x1 （带有源天线）
- **RC522 RFID 读卡器** x1 （13.56MHz）
- **SSD1306 OLED 显示屏** x1 （0.96寸，SPI 接口，7针）

### 执行器和指示器
- **有源蜂鸣器** x1
- **LED 灯** x1 （红色或绿色）
- **220Ω 电阻** x1

### 电源
- **5V 2A 电源适配器** x1
- **AMS1117-3.3V 稳压模块** x1 （可选）
- **面包板** x1 和 **杜邦线** 若干

---

## 🔌 详细接线图

### 1. 整体接线概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    ESP8266 NodeMCU 引脚图                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐                                               │
│  │   ESP8266    │        ┌──────────┐                          │
│  │   NodeMCU    │        │  NEO-6M  │                          │
│  │              │        │   GPS    │                          │
│  │  3V3 ────────┼────┬───│ VCC      │                          │
│  │              │    │   │ GND ─────┼───┐                       │
│  │  GND ────────┼────┼───│ TX ──────┼───┼───→ ESP8266 RX      │
│  │              │    │   │ RX ──────┼───┼───→ ESP8266 TX      │
│  │  D1 (GPIO5)  ├───┐│   │ PPS      │  ││                        │
│  │  D2 (GPIO4)  ├───┐││   └──────────┘  ││                        │
│  │  D5 (GPIO14) ├───┐│││                 │                        │
│  │  D6 (GPIO12) ├───┐││││   ┌──────────┐ │                        │
│  │  D7 (GPIO13) ├───┐││││   │ RC522   │ │                        │
│  │  D8 (GPIO15) ├───┐││││   │  RFID   │ │                        │
│  │  RX (GPIO3)  ├───┐│││││   │         │ │                        │
│  │  TX (GPIO1)  ├───┐││││││  │ SDA ────┼─┼───→ GPIO3 (D3)       │
│  │  D4 (GPIO2)  ├───┐││││││  │ SCK ────┼─┼───→ GPIO5 (D1)       │
│  │  D0 (GPIO16) ├───┐││││││  │ MOSI ───┼─┼───→ GPIO13 (D7)      │
│  │  D3 (GPIO0)  ├───┐││││││  │ MISO ───┼─┼───→ GPIO12 (D6)      │
│  │              │  │││││││  │ IRQ ────│  │ (不接)                 │
│  │              │  │││││││  │ GND ────┼──┼───→ GND              │
│  │              │  │││││││  │ RST ────┼──┼───→ 3.3V             │
│  │              │  │││││││  │ 3.3V ───┼──┼───→ 3.3V             │
│  │              │  │││││││  └─────────┘ ││                        │
│  │              │  │││││││             │││                        │
│  │              │  │││││││   ┌─────────┘││                        │
│  │              │  │││││││   │  OLED   │ │                        │
│  │              │  │││││││   │ SSD1306 │ │                        │
│  │              │  │││││││   │         │ │                        │
│  │              │  │││││││  │ GND ─────┼─┼───→ GND              │
│  │              │  │││││││  │ VCC ─────┼─┼───→ 3.3V             │
│  │              │  │││││││  │ SCK ─────┼─┼───→ GPIO5 (D1)       │
│  │              │  │││││││  │ SDA ─────┼─┼───→ GPIO14 (D5)      │
│  │              │  │││││││  │ RES ─────┼─┼───→ GPIO16 (D0)      │
│  │              │  │││││││  │ DC ──────┼─┼───→ GPIO2 (D4)       │
│  │              │  │││││││  │ CS ──────┼─┼───→ GPIO15 (D8)      │
│  │              │  │││││││  └─────────┘ │││                        │
│  │              │  │││││││             ││││                        │
│  │              │  │││││││   ┌─────────┘│││                        │
│  │              │  │││││││   │ 蜂鸣器  │ │││                        │
│  │              │  │││││││   │ + LED   │ │││                        │
│  │              │  │││││││   │         │ │││                        │
│  │              │  │││││││  │ (+) ─────┼─┼───→ GPIO4 (D2)       │
│  │              │  │││││││  │ (-) ─────┼─┼───→ GND (通过220Ω)    │
│  │              │  │││││││  └─────────┘ ││││                        │
│  └──────────────┘  │││││││             │││││                        │
│                    │││││││             │││││                        │
└────────────────────┴┴┴┴┴┴┴─────────────┴┴┴┴┴──────────────────────┘
```

---

## 🔧 分模块接线说明

### 2.1 ESP8266 引脚定义

| 引脚名称 | GPIO 编号 | 功能描述 | 连接模块 |
|---------|----------|---------|---------|
| 3V3 | - | 3.3V 输出 | GPS VCC, RFID 3.3V, OLED VCC |
| GND | - | 地线 | 所有模块 GND |
| D1 | GPIO5 | SPI SCK | RFID SCK, OLED SCK |
| D2 | GPIO4 | 蜂鸣器/LED | 蜂鸣器正极 |
| D3 | GPIO0 | SPI SDA (RFID) | RFID SDA |
| D4 | GPIO2 | OLED DC | OLED DC |
| D5 | GPIO14 | SPI MOSI | RFID MOSI, OLED SDA |
| D6 | GPIO12 | SPI MISO | RFID MISO |
| D7 | GPIO13 | SPI MOSI (RFID) | RFID MOSI |
| D8 | GPIO15 | SPI CS (OLED) | OLED CS |
| D0 | GPIO16 | OLED RES | OLED RES |
| RX | GPIO3 | UART RX | GPS TX |
| TX | GPIO1 | UART TX | GPS RX |

---

### 2.2 NEO-6M GPS 模块接线

| GPS 引脚 | ESP8266 引脚 | 说明 |
|---------|-------------|------|
| VCC | 3.3V | 3.3V 供电（电流约 50mA） |
| GND | GND | 地线 |
| TX | RX (GPIO3) | GPS 数据发送 |
| RX | TX (GPIO1) | GPS 数据接收 |
| PPS | (不接) | 脉冲每秒输出（可选） |

**注意事项**：
- GPS 模块需要外接有源天线，放置在窗边或室外
- 首次使用需要冷启动 1-5 分钟才能定位
- 红色 LED 不闪烁表示无法定位
- 室内基本无法收到 GPS 信号

---

### 2.3 RC522 RFID 读卡器接线

| RFID 引脚 | ESP8266 引脚 | 说明 |
|----------|-------------|------|
| SDA | D3 (GPIO0) | 片选信号 |
| SCK | D1 (GPIO5) | SPI 时钟 |
| MOSI | D7 (GPIO13) | 主机输出从机输入 |
| MISO | D6 (GPIO12) | 主机输入从机输出 |
| IRQ | (不接) | 中断请求（可选） |
| GND | GND | 地线 |
| RST | 3.3V | 复位信号（接高电平） |
| 3.3V | 3.3V | **3.3V 供电（非常重要！）** |

**⚠️ 重要警告**：
- **RC522 必须使用 3.3V 供电，接 5V 会立即烧坏模块！**
- 建议在 3.3V 线上加 100µF 电容滤波
- 读卡距离约 2-5cm

---

### 2.4 SSD1306 OLED 显示屏接线

| OLED 引脚 | ESP8266 引脚 | 说明 |
|----------|-------------|------|
| GND | GND | 地线 |
| VCC | 3.3V | 3.3V 供电（电流约 20mA） |
| SCK | D1 (GPIO5) | SPI 时钟（与 RFID 共用） |
| SDA | D5 (GPIO14) | SPI 数据 (MOSI) |
| RES | D0 (GPIO16) | 复位信号 |
| DC | D4 (GPIO2) | 数据/命令选择 |
| CS | D8 (GPIO15) | 片选信号 |

**接口类型确认**：
- 本方案使用 **SPI 接口（7 针）**
- 如果你的 OLED 是 I2C 接口（4 针），需要修改代码和接线
- SPI 接口速度更快，适合频繁刷新

---

### 2.5 蜂鸣器 + LED 指示灯接线

```
     3.3V
      │
      ├─────────→ LED 正极
      │
     [220Ω 电阻]
      │
      ├─────────→ 蜂鸣器正极
      │
      │
GPIO4 (D2) ────→ 控制信号（PWM）
      │
     GND
```

**说明**：
- 使用有源蜂鸣器（内部带振荡电路）
- LED 串联 220Ω 限流电阻
- GPIO4 输出高电平触发蜂鸣器和 LED
- 建议在 GPIO4 和蜂鸣器之间加 NPN 三极管放大

**改进方案（使用三极管驱动）**：

```
     5V
      │
     [蜂鸣器]
      │
      ├─────────→ NPN (S8050) 集电极
      │
GPIO4 (D2) ──[1kΩ]───→ NPN 基极
                      │
                     GND ──→ NPN 发射极
```

---

## ⚡ 电源供应方案

### 方案一：直接使用 USB 供电（推荐）

```
USB 5V ──→ NodeMCU VIN 引脚
           │
           └──→ 内部 AMS1117-3.3V 稳压
                │
                └──→ 输出 3.3V (最大 800mA)
```

**优点**：
- 简单，无需额外元件
- USB 供电稳定
- 足够驱动所有模块

**缺点**：
- 需要电脑或 USB 电源适配器

---

### 方案二：外部 5V 电源适配器（移动部署）

```
5V 2A 电源适配器
    │
    ├──→ VIN (NodeMCU)
    │
    └──→ AMS1117-3.3V ─→ 3.3V (RC522, OLED)
```

**元件**：
- AMS1117-3.3V 稳压芯片
- 10µF 电容 x2（输入输出各一个）
- 散热片（可选）

**电路图**：
```
   5V ───┬──[10µF]──┬── AMS1117 ──┬──[10µF]──┬── 3.3V
          │          │   VIN     VOUT │          │
         GND        GND            GND        GND
```

---

## 📊 电流消耗统计

| 模块 | 工作电流 | 峰值电流 | 说明 |
|------|---------|---------|------|
| ESP8266 | 80mA | 200mA | WiFi 发射时峰值 |
| NEO-6M GPS | 50mA | 100mA | 冷启动时峰值 |
| RC522 RFID | 30mA | 50mA | 读卡时 |
| SSD1306 OLED | 20mA | 25mA | 全屏显示时 |
| 蜂鸣器 | 20mA | 30mA | 有源蜂鸣器 |
| LED | 10mA | 15mA | 通过 220Ω 电阻 |
| **总计** | **210mA** | **420mA** | 需要预留余量 |

**电源规格要求**：
- 最小电流：500mA
- 推荐电流：1A 或以上
- 推荐电压：5V ±5%

---

## 🔨 组装步骤

### 步骤 1：准备工具和材料

- 面包板 x1
- 杜邦线（公对公、公对母）若干
- 万用表（测试用）
- 小螺丝刀（调整电位器用）

### 步骤 2：ESP8266 基础测试

1. 将 ESP8266 插到面包板上
2. 用 USB 线连接到电脑
3. 打开 Arduino IDE，选择开发板：`NodeMCU 1.0 (ESP-12E Module)`
4. 选择正确的 COM 端口
5. 上传测试程序（Blink）：

```cpp
void setup() {
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(1000);
  digitalWrite(LED_BUILTIN, LOW);
  delay(1000);
}
```

6. 观察板载 LED 是否闪烁

### 步骤 3：单个模块测试

#### 3.1 测试 OLED 显示屏

按照接线图连接 OLED，上传测试代码：

```cpp
#include <U8g2lib.h>

U8G2_SSD1306_128X64_NONAME_F_4W_SW_SPI u8g2(
  U8G2_R0,
  /* clock=*/ 5,    // SCK -> D1
  /* data=*/ 14,    // SDA -> D5
  /* cs=*/ 15,      // CS  -> D8
  /* dc=*/ 2,       // DC  -> D4
  /* reset=*/ 16    // RES -> D0
);

void setup() {
  u8g2.begin();
  u8g2.enableUTF8Print();
}

void loop() {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_ncenB14_tr);
  u8g2.setCursor(0, 20);
  u8g2.print("Hello World!");
  u8g2.sendBuffer();
  delay(1000);
}
```

**预期结果**：OLED 显示 "Hello World!"

#### 3.2 测试 RFID 读卡器

连接 RFID 模块，上传测试代码：

```cpp
#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 0    // D3
#define RST_PIN -1  // 不使用，接 3.3V

MFRC522 rfid(SS_PIN, RST_PIN);

void setup() {
  Serial.begin(9600);
  SPI.begin();
  rfid.PCD_Init();
  Serial.println("RFID Ready");
}

void loop() {
  if (rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {
    Serial.print("Card UID:");
    for (byte i = 0; i < rfid.uid.size; i++) {
      Serial.print(rfid.uid.uidByte[i] < 0x10 ? " 0" : " ");
      Serial.print(rfid.uid.uidByte[i], HEX);
    }
    Serial.println();
    rfid.PICC_HaltA();
  }
}
```

**预期结果**：刷卡后串口输出卡片 UID（如：`A3 F5 C2 D1`）

#### 3.3 测试 GPS 模块

连接 GPS 模块，上传测试代码：

```cpp
#include <TinyGPS++.h>

TinyGPSPlus gps;
HardwareSerial GPSSerial(1); // 使用 Serial1

void setup() {
  Serial.begin(9600);
  GPSSerial.begin(9600);  // GPS 默认波特率
  Serial.println("GPS Testing...");
}

void loop() {
  while (GPSSerial.available() > 0) {
    gps.encode(GPSSerial.read());
  }

  if (gps.location.isUpdated()) {
    Serial.print("Lat: ");
    Serial.print(gps.location.lat(), 6);
    Serial.print(" Lng: ");
    Serial.println(gps.location.lng(), 6);
  }

  if (millis() > 5000 && gps.charsProcessed() < 10) {
    Serial.println("No GPS data received: check wiring");
    delay(1000);
  }
}
```

**预期结果**：
- 将 GPS 放在窗边或室外
- 等待 1-5 分钟（冷启动）
- 串口输出经纬度坐标

### 步骤 4：完整组装

1. 先连接电源线（3.3V 和 GND）
2. 再连接信号线（按颜色区分）
3. 检查所有连接是否牢固
4. 用万用表测试 3.3V 是否正常
5. 上电测试

### 步骤 5：烧录完整固件

参考 `firmware/bike_firmware.ino` 文件

---

## ⚠️ 常见问题排查

### 问题 1：ESP8266 无法上传代码

**症状**：上传时提示 "Failed to connect"

**解决方案**：
1. 按住 ESP8266 上的 FLASH 按钮
2. 点击 RST 按钮（复位）
3. 松开 FLASH 按钮
4. 再次点击上传
5. 看到 "....._____" 后松开 FLASH

### 问题 2：GPS 无信号

**症状**：串口一直输出 "No GPS data"

**排查步骤**：
1. 检查天线是否连接（有源天线需接外接天线口）
2. 将 GPS 放在窗边或室外
3. 检查 TX/RX 是否接反
4. 等待至少 5 分钟（冷启动）
5. 查看 GPS 模块上的红色 LED 是否闪烁（不闪烁 = 无信号）

### 问题 3：RFID 读卡器无法识别卡片

**症状**：刷卡后无反应

**排查步骤**：
1. 检查 3.3V 供电是否正常（非常重要！）
2. 检查 SPI 接线是否正确
3. 尝试调整卡片与读卡器的距离（2-5cm）
4. 检查卡片是否损坏（用手机 NFC 测试）

### 问题 4：OLED 显示屏不亮

**症状**：屏幕全黑或全白

**排查步骤**：
1. 检查 3.3V 供电
2. 确认是 SPI 接口（7 针）而非 I2C（4 针）
3. 检查 SPI 接线顺序
4. 调整 OLED 背面的对比度电位器

### 问题 5：系统自动重启

**症状**：运行一段时间后自动重启

**原因分析**：
- 电源不足（电流不够）
- WiFi 发射时电流峰值过大

**解决方案**：
1. 使用更高功率的电源适配器（2A 或以上）
2. 在 3.3V 线上加 470µF 电容缓冲
3. 降低 WiFi 发射功率（代码中设置）

```cpp
WiFi.setOutputPower(10); // 降低到 10dBm
```

---

## 📚 参考资料

- [ESP8266 引脚图参考](https://github.com/nodemcu/nodemcu-devkit-v1.0/blob/master/NODEMCU_DEVKIT_V1.0_PINOUT.png)
- [NEO-6M 数据手册](https://www.u-blox.com/sites/default/files/products/documents/NEO-6_DataSheet_(GPS.G6-HW-09005).pdf)
- [RC522 数据手册](https://www.nxp.com/docs/en/data-sheet/MFRC522.pdf)
- [SSD1306 数据手册](https://cdn-shop.adafruit.com/datasheets/SSD1306.pdf)

---

**最后更新**：2025-01-11
**版本**：v1.0
