# 智能共享单车系统 - 硬件接线指南

## 📦 硬件清单

### 主控板
- **ESP8266 NodeMCU** x1 （ESP-12E 模块）
- USB 数据线 x1

### 传感器模块
- **ATGM336H GPS模块** x1 （支持GPS+北斗+GLONASS，带天线）
- **RC522 RFID 读卡器** x1 （13.56MHz）
- **SSD1306 OLED 显示屏** x1 （0.96寸，SPI 接口，7针）

### 执行器和指示器
- **有源蜂鸣器** x1
- **LED 灯** x1 （红色或绿色）
- **220Ω 电阻** x1

### 电源
- **5V 2A 电源适配器** x1
- **AMS1117-3.3V 稳压模块** x1 （可选）
- **面包板** x1 和 **杜邦线** 若干

---

## 🔌 详细接线图

### 1. 整体接线概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    ESP8266 NodeMCU 引脚图                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐                                               │
│  │   ESP8266    │        ┌──────────┐                          │
│  │   NodeMCU    │        │ ATGM336H │                          │
│  │              │        │   GPS    │                          │
│  │  3V3 ────────┼────┬───│ VCC      │                          │
│  │              │    │   │ GND ─────┼───┐                       │
│  │  GND ────────┼────┼───│ TX ──────┼───┼───→ ESP8266 RX      │
│  │              │    │   │ RX ──────┼───┼───→ ESP8266 TX      │
│  │  D1 (GPIO5)  ├───┐│   │ PPS      │  ││                        │
│  │  D2 (GPIO4)  ├───┐││   └──────────┘  ││                        │
│  │  D5 (GPIO14) ├───┐│││                 │                        │
│  │  D6 (GPIO12) ├───┐││││   ┌──────────┐ │                        │
│  │  D7 (GPIO13) ├───┐││││   │ RC522   │ │                        │
│  │  D8 (GPIO15) ├───┐││││   │  RFID   │ │                        │
│  │  RX (GPIO3)  ├───┐│││││   │         │ │                        │
│  │  TX (GPIO1)  ├───┐││││││  │ SDA ────┼─┼───→ GPIO3 (D3)       │
│  │  D4 (GPIO2)  ├───┐││││││  │ SCK ────┼─┼───→ GPIO5 (D1)       │
│  │  D0 (GPIO16) ├───┐││││││  │ MOSI ───┼─┼───→ GPIO13 (D7)      │
│  │  D3 (GPIO0)  ├───┐││││││  │ MISO ───┼─┼───→ GPIO12 (D6)      │
│  │              │  │││││││  │ IRQ ────│  │ (不接)                 │
│  │              │  │││││││  │ GND ────┼──┼───→ GND              │
│  │              │  │││││││  │ RST ────┼──┼───→ 3.3V             │
│  │              │  │││││││  │ 3.3V ───┼──┼───→ 3.3V             │
│  │              │  │││││││  └─────────┘ ││                        │
│  │              │  │││││││             │││                        │
│  │              │  │││││││   ┌─────────┘││                        │
│  │              │  │││││││   │  OLED   │ │                        │
│  │              │  │││││││   │ SSD1306 │ │                        │
│  │              │  │││││││   │         │ │                        │
│  │              │  │││││││  │ GND ─────┼─┼───→ GND              │
│  │              │  │││││││  │ VCC ─────┼─┼───→ 3.3V             │
│  │              │  │││││││  │ SCK ─────┼─┼───→ GPIO5 (D1)       │
│  │              │  │││││││  │ SDA ─────┼─┼───→ GPIO14 (D5)      │
│  │              │  │││││││  │ RES ─────┼─┼───→ GPIO16 (D0)      │
│  │              │  │││││││  │ DC ──────┼─┼───→ GPIO2 (D4)       │
│  │              │  │││││││  │ CS ──────┼─┼───→ GPIO15 (D8)      │
│  │              │  │││││││  └─────────┘ │││                        │
│  │              │  │││││││             ││││                        │
│  │              │  │││││││   ┌─────────┘│││                        │
│  │              │  │││││││   │ 蜂鸣器  │ │││                        │
│  │              │  │││││││   │ + LED   │ │││                        │
│  │              │  │││││││   │         │ │││                        │
│  │              │  │││││││  │ (+) ─────┼─┼───→ GPIO4 (D2)       │
│  │              │  │││││││  │ (-) ─────┼─┼───→ GND (通过220Ω)    │
│  │              │  │││││││  └─────────┘ ││││                        │
│  └──────────────┘  │││││││             │││││                        │
│                    │││││││             │││││                        │
└────────────────────┴┴┴┴┴┴┴─────────────┴┴┴┴┴──────────────────────┘
```

**⚠️ 重要提示**：
1. 本设计使用**双SPI总线**配置（硬件SPI + 软件SPI），虽然多用一个GPIO，但性能更稳定
2. RFID使用ESP8266的硬件SPI（固定引脚：SCK=GPIO14, MISO=GPIO12, MOSI=GPIO13）
3. OLED使用软件SPI（可自定义引脚，避免与RFID冲突）
4. GPIO14(D5)被RFID的SCK和OLED的SDA同时使用，但它们是独立的SPI总线，不会冲突

---

## 🔧 分模块接线说明

### 2.1 ESP8266 引脚定义

| 引脚名称 | GPIO 编号 | 功能描述 | 连接模块 |
|---------|----------|---------|---------|
| 3V3 | - | 3.3V 输出 | RFID 3.3V, OLED VCC |
| VIN | - | 5V 输入（从USB） | GPS VCC (ATGM336H支持3.3V-5V) |
| GND | - | 地线 | 所有模块 GND |
| D1 | GPIO5 | SPI SCK (OLED软件SPI) | OLED SCK |
| D2 | GPIO4 | 蜂鸣器/LED | 蜂鸣器正极 |
| D3 | GPIO0 | RFID CS (片选) | RFID SDA |
| D4 | GPIO2 | OLED DC | OLED DC |
| D5 | GPIO14 | SPI MOSI (OLED软件SPI) | OLED SDA |
| D6 | GPIO12 | SPI MISO (RFID硬件SPI) | RFID MISO |
| D7 | GPIO13 | SPI MOSI (RFID硬件SPI) | RFID MOSI |
| D8 | GPIO15 | OLED CS (片选) | OLED CS |
| D0 | GPIO16 | OLED RES | OLED RES |
| RX | GPIO3 | UART RX | GPS TX |
| TX | GPIO1 | UART TX | GPS RX |

**📌 SPI总线说明**：
本设计使用**双SPI总线**配置以优化性能：
- **RFID**：使用ESP8266的**硬件SPI**（更快、更稳定）
  - SCK = GPIO14 (D5)
  - MISO = GPIO12 (D6)
  - MOSI = GPIO13 (D7)
  - CS = GPIO0 (D3)

- **OLED**：使用**软件SPI**（速度要求较低）
  - SCK = GPIO5 (D1)d0
  - MOSI/SDA = GPIO14 (D5)d1
  - CS = GPIO15 (D8)
  - DC = GPIO2 (D4)
  - RES = GPIO16 (D0)

**优点**：虽然多用一个GPIO（GPIO13），但避免了总线冲突，提高系统稳定性。

---

### 2.2 ATGM336H GPS 模块接线

| GPS 引脚 | ESP8266 引脚 | 说明 |
|---------|-------------|------|
| VCC | 3.3V 或 VIN | 3.3V-5V 供电（推荐5V，电流约 50mA） |
| GND | GND | 地线 |
| TX | RX (GPIO3) | GPS 数据发送 |
| RX | TX (GPIO1) | GPS 数据接收（可选） |
| PPS | (不接) | 脉冲每秒输出（可选） |

**ATGM336H 优势**：
- ✅ 支持 **GPS + 北斗 + GLONASS** 多星定位
- ✅ 定位速度更快（冷启动约30秒-2分钟）
- ✅ 定位精度更高（< 2.5米 CEP）
- ✅ 支持有源和无源天线
- ✅ 低功耗（约 40mA @ 3.3V）

**注意事项**：
- GPS 模块需要外接天线，放置在窗边或室外
- 首次使用需要冷启动 30秒-2分钟（比NEO-6M快很多）
- 建议使用5V供电以获得最佳性能
- 室内基本无法收到 GPS 信号
- 支持9600和115200波特率（默认9600）

---

### 2.3 RC522 RFID 读卡器接线

| RFID 引脚 | ESP8266 引脚 | 说明 |
|----------|-------------|------|
| SDA (CS) | D3 (GPIO0) | 片选信号 |
| SCK | D5 (GPIO14) | SPI 时钟（硬件SPI） |
| MOSI | D7 (GPIO13) | 主机输出从机输入（硬件SPI） |
| MISO | D6 (GPIO12) | 主机输入从机输出（硬件SPI） |
| IRQ | (不接) | 中断请求（可选） |
| GND | GND | 地线 |
| RST | 3.3V | 复位信号（接高电平） |
| 3.3V | 3.3V | **3.3V 供电（非常重要！）** |

**⚠️ 重要提示**：
- RFID使用ESP8266的**硬件SPI**，使用固定引脚配置
- 与OLED使用不同的SPI总线，避免冲突

**⚠️ 重要警告**：
- **RC522 必须使用 3.3V 供电，接 5V 会立即烧坏模块！**
- 建议在 3.3V 线上加 100µF 电容滤波
- 读卡距离约 2-5cm

---

### 2.4 SSD1306 OLED 显示屏接线

| OLED 引脚 | ESP8266 引脚 | 说明 |
|----------|-------------|------|
| GND | GND | 地线 |
| VCC | 3.3V | 3.3V 供电（电流约 20mA） |
| SCK | D1 (GPIO5) | SPI 时钟（与 RFID 共用） |
| SDA | D5 (GPIO14) | SPI 数据 (MOSI) |
| RES | D0 (GPIO16) | 复位信号 |
| DC | D4 (GPIO2) | 数据/命令选择 |
| CS | D8 (GPIO15) | 片选信号 |

**接口类型确认**：
- 本方案使用 **SPI 接口（7 针）**
- 如果你的 OLED 是 I2C 接口（4 针），需要修改代码和接线
- SPI 接口速度更快，适合频繁刷新

---

### 2.5 蜂鸣器 + LED 指示灯接线

#### 📋 蜂鸣器类型说明

**有源蜂鸣器 vs 无源蜂鸣器**：

| 特性 | 有源蜂鸣器 | 无源蜂鸣器 |
|------|-----------|-----------|
| 内部振荡电路 | ✅ 有 | ❌ 无 |
| 控制方式 | 直流电平 | PWM方波 |
| 声音频率 | 固定频率 | 可调频率 |
| 价格 | 略高 | 较低 |
| 使用难度 | 简单 | 需要tone()函数 |
| **本项目推荐** | ✅ **推荐使用** | ⚠️ 也可以 |

**如何区分**：
- 有源蜂鸣器：通常标注为"Active"或有黑色贴纸
- 无源蜂鸣器：通常标注为"Passive"或没有贴纸
- 测试方法：接5V电源，有固定声音=有源；无声音或轻微"咔"声=无源

---

#### 方案一：简单直接驱动（推荐新手）

**适用场景**：有源蜂鸣器、小功率应用（< 20mA）

```
┌─────────────────────────────────────────────┐
│          ESP8266 NodeMCU                    │
│                                             │
│  3.3V ────────┐                             │
│               │                             │
│               ├───[220Ω]───→ LED(+)         │
│               │        │                    │
│               │        ├───→ 蜂鸣器(+)      │
│               │                             │
│  D2 (GPIO4) ──┼─── 控制信号                 │
│               │                             │
│  GND ─────────┼───→ LED(-)                  │
│               └───→ 蜂鸣器(-)               │
│                                             │
└─────────────────────────────────────────────┘
```

**详细接线表**：

| 元件 | 引脚 | 连接到ESP8266 | 说明 |
|------|------|--------------|------|
| **有源蜂鸣器** | 正极(+） | D2 (GPIO4) 或 3.3V | 控制信号或电源正极 |
| | 负极(-) | GND | 地线 |
| **LED** | 正极(+） | 通过220Ω电阻接3.3V | 限流电阻很重要！ |
| | 负极(-) | D2 (GPIO4) 或 GND | 控制信号或地线 |

**两种连接方式**：

**方式A：高电平触发**
```
蜂鸣器正极 → D2 (GPIO4)
蜂鸣器负极 → GND

LED正极 → 3.3V (通过220Ω电阻)
LED负极 → D2 (GPIO4)

结果：GPIO输出HIGH时，蜂鸣器和LED同时工作
```

**方式B：低电平触发（推荐）**
```
蜂鸣器正极 → 3.3V
蜂鸣器负极 → D2 (GPIO4)

LED正极 → D2 (GPIO4) (通过220Ω电阻)
LED负极 → GND

结果：GPIO输出LOW时，蜂鸣器和LED同时工作
```

**元件清单**：
- 有源蜂鸣器 x1（5V或3.3V均可）
- LED（红色或绿色）x1
- 220Ω 电阻 x1（LED限流）
- 杜邦线若干

**⚠️ 注意事项**：
1. **LED必须有220Ω电阻**，否则会烧坏LED或GPIO
2. **有源蜂鸣器会持续发声**，只要给电就一直响
3. **GPIO最大输出电流**：12mA，不要超过
4. **如果蜂鸣器不够响**，使用方案二的三极管驱动

---

#### 方案二：三极管驱动（推荐用于实际项目）

**适用场景**：需要更大音量、驱动无源蜂鸣器、保护GPIO

```
┌──────────────────────────────────────────────┐
│         ESP8266 NodeMCU                      │
│                                              │
│  5V 或 3.3V ────┐                            │
│                │                            │
│             [蜂鸣器]                          │
│                │                            │
│                ├───→ 集电极 (C)              │
│                │        │                   │
│                │     S8050                   │
│                │     NPN三极管               │
│  D2 (GPIO4) ──┴─[1kΩ]───→ 基极 (B)         │
│                             │                │
│  GND ───────────────────────┴─→ 发射极 (E)   │
│                                              │
└──────────────────────────────────────────────┘
```

**详细接线**：

| 连接 | 元件引脚 | ESP8266引脚 | 说明 |
|------|---------|------------|------|
| 三极管B → GPIO | 基极(B) | D2 (GPIO4) 通过1kΩ电阻 | 控制信号 |
| 三极管E → GND | 发射极(E) | GND | 地线 |
| 三极管C → 蜂鸣器+ | 集电极(C) | 蜂鸣器正极 | 驱动电流 |
| 蜂鸣器- → GND | 蜂鸣器负极 | GND | 地线 |
| 5V/3.3V | 电源 | VIN(5V) 或 3.3V | 蜂鸣器供电 |

**NPN三极管引脚识别**（S8050为例）：
```
        ┌───┐
   B ───┤   ├─── E  (平面朝向自己)
        └───┘
         │
         C
```
或参考三极管数据手册的引脚图

**元件清单**：
- NPN三极管（S8050或2N2222）x1
- 1kΩ 电阻 x1（基极限流）
- 有源/无源蜂鸣器 x1
- 杜邦线若干

**优点**：
- ✅ 可以驱动更大功率的蜂鸣器（> 100mA）
- ✅ 保护ESP8266的GPIO引脚
- ✅ 蜂鸣器更响
- ✅ 可以驱动无源蜂鸣器

---

#### LED 独立接线方案（可选）

如果你想让LED独立控制（不与蜂鸣器同时工作），可以使用两个GPIO：

```
GPIO4 (D2) ──[1kΩ]───→ NPN基极 ──→ 蜂鸣器
GPIO15 (D8) ────[220Ω]───→ LED ──→ GND
```

**代码示例**：
```cpp
#define BUZZER_PIN 4
#define LED_PIN 15

void setup() {
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);
}

void playBeep() {
  digitalWrite(BUZZER_PIN, HIGH);  // 蜂鸣器响
  digitalWrite(LED_PIN, HIGH);      // LED亮
  delay(100);
  digitalWrite(BUZZER_PIN, LOW);   // 蜂鸣器停
  digitalWrite(LED_PIN, LOW);       // LED灭
}
```

---

#### 🔧 如何选择电阻值

**LED限流电阻计算**：
```
电阻值 = (电源电压 - LED压降) / LED电流

例如（3.3V供电，红色LED）：
R = (3.3V - 2.0V) / 0.02A = 65Ω

推荐使用220Ω（更安全，亮度稍低）
```

**常用LED颜色和压降**：
| LED颜色 | 压降(V) | 推荐电阻(3.3V) | 推荐电阻(5V) |
|---------|---------|--------------|-------------|
| 红色 | 2.0 | 150Ω-220Ω | 300Ω-470Ω |
| 绿色 | 2.2 | 100Ω-150Ω | 270Ω-330Ω |
| 黄色 | 2.1 | 120Ω-180Ω | 290Ω-390Ω |
| 蓝色/白色 | 3.0 | 150Ω-220Ω | 100Ω-150Ω |

**三极管基极电阻**：
- 推荐值：1kΩ - 10kΩ
- 计算：R = (GPIO电压 - Vbe) / 基极电流
- 一般1kΩ-2.2kΩ即可

---

#### 🧪 测试代码

**测试蜂鸣器和LED**：

```cpp
#define BUZZER_PIN 4  // D2
#define LED_PIN 4     // 如果独立控制，改为其他GPIO

void setup() {
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(LED_PIN, OUTPUT);

  Serial.begin(9600);
  Serial.println("\n蜂鸣器和LED测试");
}

void loop() {
  // 测试1：简单开关
  Serial.println("测试1: 开关测试");
  digitalWrite(BUZZER_PIN, HIGH);
  digitalWrite(LED_PIN, HIGH);
  delay(1000);
  digitalWrite(BUZZER_PIN, LOW);
  digitalWrite(LED_PIN, LOW);
  delay(1000);

  delay(2000);

  // 测试2：短促提示音
  Serial.println("测试2: 短促提示音");
  for (int i = 0; i < 3; i++) {
    digitalWrite(BUZZER_PIN, HIGH);
    digitalWrite(LED_PIN, HIGH);
    delay(100);
    digitalWrite(BUZZER_PIN, LOW);
    digitalWrite(LED_PIN, LOW);
    delay(200);
  }

  delay(2000);

  // 测试3：不同长度的提示音
  Serial.println("测试3: 不同长度");
  playBeep(1, 50);   // 1次短音
  delay(500);
  playBeep(2, 200);  // 2次长音
  delay(500);
  playBeep(3, 100);  // 3次中音

  delay(3000);
}

void playBeep(int times, int duration) {
  for (int i = 0; i < times; i++) {
    digitalWrite(BUZZER_PIN, HIGH);
    digitalWrite(LED_PIN, HIGH);
    delay(duration);
    digitalWrite(BUZZER_PIN, LOW);
    digitalWrite(LED_PIN, LOW);
    if (i < times - 1) {
      delay(100);
    }
  }
}
```

**预期结果**：
- 蜂鸣器发出"滴滴"声
- LED与蜂鸣器同步闪烁
- 串口输出测试信息

---

#### ❌ 常见问题

**问题1：蜂鸣器不响**
- 检查极性是否正确
- 检查GPIO是否输出HIGH/LOW
- 用万用表测试蜂鸣器电压
- 确认是有源蜂鸣器（不是无源）

**问题2：LED不亮**
- 检查LED极性（长脚为正极）
- 检查是否有220Ω限流电阻
- 尝试反接LED方向
- 用万用表测试GPIO电压

**问题3：蜂鸣器声音太小**
- 使用三极管驱动（方案二）
- 检查供电电压（5V比3.3V更响）
- 确认是有源蜂鸣器
- 检查蜂鸣器额定功率

**问题4：ESP8266重启**
- GPIO电流过大（>12mA）
- 使用三极管驱动
- 检查是否短路

---

#### 💡 推荐配置

**最佳实践（推荐用于本项目）**：

```
配置：三极管驱动 + 独立LED
- 蜂鸣器：使用S8050三极管驱动，接GPIO4
- LED：独立控制，接GPIO15（D8），使用220Ω电阻
- 优点：音量大、保护GPIO、LED独立控制
```

---

## ⚡ 电源供应方案

### 方案一：直接使用 USB 供电（推荐）

```
USB 5V ──→ NodeMCU VIN 引脚
           │
           └──→ 内部 AMS1117-3.3V 稳压
                │
                └──→ 输出 3.3V (最大 800mA)
```

**优点**：
- 简单，无需额外元件
- USB 供电稳定
- 足够驱动所有模块

**缺点**：
- 需要电脑或 USB 电源适配器

---

### 方案二：外部 5V 电源适配器（移动部署）

```
5V 2A 电源适配器
    │
    ├──→ VIN (NodeMCU)
    │
    └──→ AMS1117-3.3V ─→ 3.3V (RC522, OLED)
```

**元件**：
- AMS1117-3.3V 稳压芯片
- 10µF 电容 x2（输入输出各一个）
- 散热片（可选）

**电路图**：
```
   5V ───┬──[10µF]──┬── AMS1117 ──┬──[10µF]──┬── 3.3V
          │          │   VIN     VOUT │          │
         GND        GND            GND        GND
```

---

## 📊 电流消耗统计

| 模块 | 工作电流 | 峰值电流 | 说明 |
|------|---------|---------|------|
| ESP8266 | 80mA | 200mA | WiFi 发射时峰值 |
| ATGM336H GPS | 40mA | 80mA | 多星定位时功耗更低 |
| RC522 RFID | 30mA | 50mA | 读卡时 |
| SSD1306 OLED | 20mA | 25mA | 全屏显示时 |
| 蜂鸣器 | 20mA | 30mA | 有源蜂鸣器 |
| LED | 10mA | 15mA | 通过 220Ω 电阻 |
| **总计** | **200mA** | **400mA** | 需要预留余量 |

**电源规格要求**：
- 最小电流：500mA
- 推荐电流：1A 或以上
- 推荐电压：5V ±5%

---

## 🔨 组装步骤

### 步骤 1：准备工具和材料

- 面包板 x1
- 杜邦线（公对公、公对母）若干
- 万用表（测试用）
- 小螺丝刀（调整电位器用）

### 步骤 2：ESP8266 基础测试

1. 将 ESP8266 插到面包板上
2. 用 USB 线连接到电脑
3. 打开 Arduino IDE，选择开发板：`NodeMCU 1.0 (ESP-12E Module)`
4. 选择正确的 COM 端口
5. 上传测试程序（Blink）：

```cpp
void setup() {
  pinMode(LED_BUILTIN, OUTPUT);
}

void loop() {
  digitalWrite(LED_BUILTIN, HIGH);
  delay(1000);
  digitalWrite(LED_BUILTIN, LOW);
  delay(1000);
}
```

6. 观察板载 LED 是否闪烁

### 步骤 3：单个模块测试

#### 3.1 测试 OLED 显示屏

按照接线图连接 OLED，上传测试代码：

```cpp
#include <U8g2lib.h>

U8G2_SSD1306_128X64_NONAME_F_4W_SW_SPI u8g2(
  U8G2_R0,
  /* clock=*/ 5,    // SCK -> D1
  /* data=*/ 14,    // SDA -> D5
  /* cs=*/ 15,      // CS  -> D8
  /* dc=*/ 2,       // DC  -> D4
  /* reset=*/ 16    // RES -> D0
);

void setup() {
  u8g2.begin();
  u8g2.enableUTF8Print();
}

void loop() {
  u8g2.clearBuffer();
  u8g2.setFont(u8g2_font_ncenB14_tr);
  u8g2.setCursor(0, 20);
  u8g2.print("Hello World!");
  u8g2.sendBuffer();
  delay(1000);
}
```

**预期结果**：OLED 显示 "Hello World!"

#### 3.2 测试 RFID 读卡器

连接 RFID 模块，上传测试代码：

```cpp
#include <SPI.h>
#include <MFRC522.h>

#define SS_PIN 0    // D3
#define RST_PIN -1  // 不使用，接 3.3V

MFRC522 rfid(SS_PIN, RST_PIN);

void setup() {
  Serial.begin(9600);
  SPI.begin();
  rfid.PCD_Init();
  Serial.println("RFID Ready");
}

void loop() {
  if (rfid.PICC_IsNewCardPresent() && rfid.PICC_ReadCardSerial()) {
    Serial.print("Card UID:");
    for (byte i = 0; i < rfid.uid.size; i++) {
      Serial.print(rfid.uid.uidByte[i] < 0x10 ? " 0" : " ");
      Serial.print(rfid.uid.uidByte[i], HEX);
    }
    Serial.println();
    rfid.PICC_HaltA();
  }
}
```

**预期结果**：刷卡后串口输出卡片 UID（如：`A3 F5 C2 D1`）

#### 3.3 测试 GPS 模块

连接 GPS 模块，上传测试代码：

```cpp
#include <TinyGPS++.h>

TinyGPSPlus gps;
HardwareSerial GPSSerial(1); // 使用 Serial1

void setup() {
  Serial.begin(9600);
  GPSSerial.begin(9600);  // GPS 默认波特率
  Serial.println("GPS Testing...");
}

void loop() {
  while (GPSSerial.available() > 0) {
    gps.encode(GPSSerial.read());
  }

  if (gps.location.isUpdated()) {
    Serial.print("Lat: ");
    Serial.print(gps.location.lat(), 6);
    Serial.print(" Lng: ");
    Serial.println(gps.location.lng(), 6);
  }

  if (millis() > 5000 && gps.charsProcessed() < 10) {
    Serial.println("No GPS data received: check wiring");
    delay(1000);
  }
}
```

**预期结果**：
- 将 GPS 放在窗边或室外
- 等待 1-5 分钟（冷启动）
- 串口输出经纬度坐标

### 步骤 4：完整组装

1. 先连接电源线（3.3V 和 GND）
2. 再连接信号线（按颜色区分）
3. 检查所有连接是否牢固
4. 用万用表测试 3.3V 是否正常
5. 上电测试

### 步骤 5：烧录完整固件

参考 `firmware/bike_firmware.ino` 文件

---

## ⚠️ 常见问题排查

### 问题 1：ESP8266 无法上传代码

**症状**：上传时提示 "Failed to connect"

**解决方案**：
1. 按住 ESP8266 上的 FLASH 按钮
2. 点击 RST 按钮（复位）
3. 松开 FLASH 按钮
4. 再次点击上传
5. 看到 "....._____" 后松开 FLASH

### 问题 2：GPS 无信号

**症状**：串口一直输出 "No GPS data"

**排查步骤**：
1. 检查天线是否连接（有源天线需接外接天线口）
2. 将 GPS 放在窗边或室外
3. 检查 TX/RX 是否接反
4. 等待至少 5 分钟（冷启动）
5. 查看 GPS 模块上的红色 LED 是否闪烁（不闪烁 = 无信号）

### 问题 3：RFID 读卡器无法识别卡片

**症状**：刷卡后无反应

**排查步骤**：
1. 检查 3.3V 供电是否正常（非常重要！）
2. 检查 SPI 接线是否正确
3. 尝试调整卡片与读卡器的距离（2-5cm）
4. 检查卡片是否损坏（用手机 NFC 测试）

### 问题 4：OLED 显示屏不亮

**症状**：屏幕全黑或全白

**排查步骤**：
1. 检查 3.3V 供电
2. 确认是 SPI 接口（7 针）而非 I2C（4 针）
3. 检查 SPI 接线顺序
4. 调整 OLED 背面的对比度电位器

### 问题 5：系统自动重启

**症状**：运行一段时间后自动重启

**原因分析**：
- 电源不足（电流不够）
- WiFi 发射时电流峰值过大

**解决方案**：
1. 使用更高功率的电源适配器（2A 或以上）
2. 在 3.3V 线上加 470µF 电容缓冲
3. 降低 WiFi 发射功率（代码中设置）

```cpp
WiFi.setOutputPower(10); // 降低到 10dBm
```

---

## 📚 参考资料

- [ESP8266 引脚图参考](https://github.com/nodemcu/nodemcu-devkit-v1.0/blob/master/NODEMCU_DEVKIT_V1.0_PINOUT.png)
- [NEO-6M 数据手册](https://www.u-blox.com/sites/default/files/products/documents/NEO-6_DataSheet_(GPS.G6-HW-09005).pdf)
- [RC522 数据手册](https://www.nxp.com/docs/en/data-sheet/MFRC522.pdf)
- [SSD1306 数据手册](https://cdn-shop.adafruit.com/datasheets/SSD1306.pdf)

---

**最后更新**：2025-01-12
**版本**：v1.1 (更新为ATGM336H GPS模块)
