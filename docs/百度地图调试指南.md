# 百度地图调试指南

## 🔍 地图没有显示？按以下步骤排查

### 步骤 1：检查环境变量是否正确加载

1. **打开浏览器开发者工具**
   - 按 `F12`
   - 切换到 `Console` 标签

2. **查找日志输出**
   刷新页面后，应该能看到类似日志：
   ```
   [MapConfig] 百度地图 AK 配置: jksZSsiBeT...
   [MapConfig] 环境变量可用: {VITE_BAIDU_MAP_AK: true, ...}
   [MapView] 开始初始化地图, AK: jksZSsiBeT...
   ```

3. **如果没有看到这些日志**
   - 环境变量没有正确加载
   - 需要重启前端服务（见步骤2）

### 步骤 2：重启前端服务

**重要：修改 .env.local 后必须重启服务**

1. **停止当前服务**
   - 在运行 `npm run dev` 的终端按 `Ctrl + C`

2. **重新启动**
   ```bash
   cd frontend
   npm run dev
   ```

3. **验证环境变量**
   启动后应该看到 Vite 输出类似：
   ```
   VITE v5.4.21  ready in 337 ms
   ```

### 步骤 3：检查 .env.local 文件

1. **文件位置**
   ```
   E:\IOT-Final\frontend\.env.local
   ```

2. **文件内容格式**
   ```env
   # 百度地图配置
   VITE_BAIDU_MAP_AK=jksZSsiBeTjquXGqa14E3jCZygkS44ky

   # API 服务器地址
   VITE_API_BASE_URL=http://localhost:8000
   ```

3. **注意事项**
   - ✅ AK 前面没有空格
   - ✅ 使用等号 `=` 分隔
   - ✅ 必须以 `VITE_` 开头
   - ❌ 不要使用引号
   - ❌ 不要使用中文标点

### 步骤 4：检查 AK 是否有效

1. **打开浏览器控制台**（F12）
2. **查看 Network 标签**
3. **查找加载失败的资源**
   - 如果看到 `api.map.baidu.com/api?v=3.0&ak=...` 状态为 403/404
   - 说明 AK 无效或 Referer 白名单配置错误

4. **验证 AK**
   访问以下URL（替换AK）：
   ```
   https://api.map.baidu.com/api?v=3.0&ak=jksZSsiBeTjquXGqa14E3jCZygkS44ky
   ```
   - 如果返回 JavaScript 代码 → AK 有效
   - 如果返回错误 → AK 无效

### 步骤 5：检查 Referer 白名单

**常见错误：Referer 白名单格式不正确**

在百度地图控制台检查白名单配置：

✅ **正确格式：**
```
localhost:5173
```

❌ **错误格式：**
```
http://localhost:5173
localhost:5173/
```

### 步骤 6：检查控制台错误信息

在浏览器控制台（F12 → Console）查找错误：

**错误1：** `百度地图 API Key 未配置`
- 原因：环境变量没有正确加载
- 解决：重启前端服务

**错误2：** `ReferenceError: BMap is not defined`
- 原因：百度地图脚本加载失败
- 解决：检查网络连接、AK有效性

**错误3：** `Uncaught SyntaxError`
- 原因：百度地图脚本返回错误内容
- 解决：检查 Referer 白名单

**错误4：** `Uncaught TypeError: Cannot read properties of undefined`
- 原因：地图容器未准备好
- 解决：等待DOM加载完成

### 步骤 7：手动测试地图

在控制台输入以下代码测试：

```javascript
// 检查 BMap 是否可用
console.log('BMap available:', typeof BMap !== 'undefined');

// 如果可用，手动创建地图
if (typeof BMap !== 'undefined') {
  const map = new BMap.Map("map");
  const point = new BMap.Point(116.404, 39.915);
  map.centerAndZoom(point, 15);
}
```

### 步骤 8：检查地图容器

1. **页面元素检查**
   - 右键点击地图区域
   - 选择"检查"
   - 查看是否有 `id` 或 `ref` 属性的 div

2. **容器尺寸**
   在控制台输入：
   ```javascript
   console.log('容器尺寸:', document.querySelector('[ref="mapContainerRef"]')?.offsetWidth);
   ```
   - 应该输出大于 0 的数字
   - 如果输出 `undefined`，容器不存在

### 步骤 9：检查浏览器兼容性

支持的浏览器：
- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+

### 步骤 10：完整重置

如果以上都不行，尝试完整重置：

```bash
# 1. 停止前端服务 (Ctrl+C)

# 2. 清理缓存
cd frontend
rm -rf node_modules/.vite

# 3. 重启服务
npm run dev
```

---

## 🆘 仍然无法解决？

### 收集以下信息并寻求帮助：

1. **控制台日志**（F12 → Console → 截图）
2. **Network 标签**（F12 → Network → 筛选 `api.map.baidu.com` → 截图）
3. **.env.local 内容**（AK 可以打码）
4. **百度地图控制台配置截图**（隐藏敏感信息）

### 快速测试命令

在控制台运行：
```javascript
console.log('环境变量检查:', {
  akConfigured: !!import.meta.env?.VITE_BAIDU_MAP_AK,
  akPrefix: import.meta.env?.VITE_BAIDU_MAP_AK?.substring(0, 10) + '...',
  bMapLoaded: typeof BMap !== 'undefined',
  mapContainer: !!document.querySelector('[ref="mapContainerRef"]')
});
```

---

## 💡 常见问题快速修复

| 问题 | 解决方案 |
|------|---------|
| AK未配置 | 重启 `npm run dev` |
| BMap undefined | 检查网络连接 |
| 地图空白 | 检查容器尺寸 |
| Referer错误 | 修改白名单为 `localhost:5173` |
| 403错误 | 检查AK是否复制正确 |

---

**最后提示**：99% 的问题都是环境变量没有正确加载导致的。修改 `.env.local` 后**必须重启**前端服务！
